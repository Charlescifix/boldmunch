<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Order Form ‚Äî Bold Munch</title>
  <meta name="description" content="Complete your Bold Munch order with our secure checkout form. Enter delivery details and confirm your premium handmade treats.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --cream:#FFF9F3;
      --gold:#F1C40F;
      --bronze:#8B4513;
      --burgundy:#E67E22;
      --sage:#27AE60;
      --charcoal:#1A1A1A;
      --glass: rgba(255,255,255,0.7);
      --glass-dark: rgba(255,255,255,0.45);
      --radius-lg: 24px;
      --radius-sm: 16px;
      --shadow: 0 12px 40px rgba(0,0,0,.15);
      --shadow-soft: 0 8px 24px rgba(0,0,0,.1);
      --shadow-luxury: 0 16px 50px rgba(230,126,34,.2);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,var(--cream),#ffffff);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--charcoal)}
    
    .container{max-width:800px;margin:0 auto;padding:20px}
    
    /* Header */
    .header{
      text-align:center;
      margin-bottom:40px;
      padding:20px;
      background:var(--glass);
      border-radius:var(--radius-lg);
      border:1px solid rgba(255,255,255,.65);
    }
    
    .logo{
      width:120px;height:120px;border-radius:30px;
      object-fit:contain;margin:0 auto 20px;
      box-shadow:0 20px 60px rgba(211,84,0,0.7), var(--shadow);
      border:6px solid rgba(255,255,255,0.6);
    }
    
    .tagline{
      font-size:16px;color:var(--bronze);
      font-weight:600;
      margin-bottom:8px;
    }
    
    .quote{
      font-style:italic;
      color:var(--sage);
      margin-top:16px;
      font-size:15px;
    }

    /* Form Styles */
    .form-section{
      background:var(--glass);
      border-radius:var(--radius-lg);
      padding:24px;
      margin-bottom:24px;
      border:1px solid rgba(255,255,255,.65);
      box-shadow:var(--shadow-soft);
    }
    
    /* Darker background for order total section */
    .form-section.order-total{
      background:rgba(255,255,255,0.3);
      border:1px solid rgba(255,255,255,.4);
    }
    
    .section-title{
      font-family:Poppins,sans-serif;
      font-size:20px;
      font-weight:700;
      margin-bottom:20px;
      color:var(--charcoal);
    }
    
    .form-group{
      margin-bottom:20px;
    }
    
    .form-label{
      display:block;
      margin-bottom:8px;
      font-weight:600;
      color:var(--charcoal);
    }
    
    .form-input{
      width:100%;
      padding:12px 16px;
      border:2px solid rgba(241,196,15,0.3);
      border-radius:12px;
      background:linear-gradient(145deg,#FFFFFF,#F8F9FA);
      font-size:16px;
      font-weight:500;
      transition:all 0.3s ease;
    }
    
    .form-input:focus{
      outline:none;
      border-color:var(--gold);
      box-shadow:0 0 0 3px rgba(241,196,15,0.2);
    }
    
    .form-input.error{
      border-color:#e74c3c;
      box-shadow:0 0 0 3px rgba(231,76,60,0.2);
    }
    
    .error-message{
      color:#e74c3c;
      font-size:14px;
      margin-top:8px;
      font-weight:600;
    }
    
    .success-message{
      color:var(--sage);
      font-size:14px;
      margin-top:8px;
      font-weight:600;
    }

    /* Order Summary */
    .order-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 0;
      border-bottom:1px solid rgba(241,196,15,0.2);
    }
    
    .order-item:last-child{
      border-bottom:none;
    }
    
    .item-details{
      flex:1;
    }
    
    .item-name{
      font-weight:700;
      margin-bottom:4px;
    }
    
    .item-meta{
      font-size:13px;
      color:var(--bronze);
    }
    
    .item-price{
      font-weight:800;
      color:var(--burgundy);
    }
    
    .remove-item-btn{
      background:#e74c3c;color:white;border:none;
      width:44px;height:44px;border-radius:22px;cursor:pointer;
      font-size:18px;font-weight:bold;margin-left:12px;
      transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;
    }
    .remove-item-btn:hover{
      background:#c0392b;transform:scale(1.1);
    }
    
    .total-row{
      display:flex;
      justify-content:space-between;
      padding:12px 0;
      font-weight:700;
    }
    
    .total-row.final{
      border-top:2px solid var(--gold);
      margin-top:12px;
      font-size:18px;
      color:var(--burgundy);
    }

    /* Delivery Info */
    .delivery-info{
      background:linear-gradient(135deg,rgba(39,174,96,0.1),rgba(39,174,96,0.05));
      border:2px solid rgba(39,174,96,0.3);
      border-radius:12px;
      padding:16px;
      margin:16px 0;
    }
    
    .delivery-free{
      background:linear-gradient(135deg,rgba(39,174,96,0.2),rgba(39,174,96,0.1));
      border-color:var(--sage);
    }
    
    .delivery-paid{
      background:linear-gradient(135deg,rgba(230,126,34,0.1),rgba(230,126,34,0.05));
      border-color:var(--burgundy);
    }
    
    .delivery-unavailable{
      background:linear-gradient(135deg,rgba(231,76,60,0.1),rgba(231,76,60,0.05));
      border-color:#e74c3c;
    }

    /* Buttons */
    .btn{
      background:linear-gradient(145deg,var(--burgundy),#D35400);
      color:#fff;
      font-weight:800;
      border:none;
      padding:16px 24px;
      border-radius:20px;
      cursor:pointer;
      font-size:16px;
      transition:all 0.3s ease;
      letter-spacing:0.5px;
      text-transform:uppercase;
      width:100%;
      margin-top:16px;
    }
    
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 25px rgba(230,126,34,0.4);
    }
    
    .btn:disabled{
      background:linear-gradient(145deg,#ccc,#999);
      cursor:not-allowed;
      transform:none;
      opacity:0.6;
    }
    
    .btn-secondary{
      background:transparent;
      color:var(--charcoal);
      border:2px solid var(--gold);
    }
    
    .btn-secondary:hover{
      background:var(--gold);
      color:var(--charcoal);
    }

    /* Loading States */
    .loading{
      opacity:0.6;
      pointer-events:none;
    }
    
    .spinner{
      border:3px solid rgba(241,196,15,0.3);
      border-top:3px solid var(--gold);
      border-radius:50%;
      width:24px;
      height:24px;
      animation:spin 1s linear infinite;
      display:inline-block;
      margin-right:8px;
    }
    
    @keyframes spin{
      0%{transform:rotate(0deg)}
      100%{transform:rotate(360deg)}
    }

    /* Tablet Responsiveness (768px - 1024px) */
    @media (max-width:1024px) and (min-width:769px){
      .container{max-width:700px;padding:18px}
      .form-section{padding:22px}
      .logo{width:110px;height:110px}
      .section-title{font-size:19px}
      .form-input{padding:14px 18px;font-size:15px}
      .btn{padding:15px 22px;font-size:15px}
      .order-item{padding:14px 0}
      .item-name{font-size:16px}
      .item-meta{font-size:14px}
    }

    /* Mobile Responsiveness (768px and below) */
    @media (max-width:768px){
      .container{padding:16px}
      .form-section{padding:20px}
      .brand-name{font-size:24px}
    }
    
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <a href="/" style="display:inline-block;" aria-label="Return to Bold Munch homepage"><img src="new_logo.png" alt="Bold Munch Logo" class="logo" loading="lazy" /></a>
      <div class="tagline">Premium Handmade Goodness</div>
      <div class="quote">"Fresh ingredients, bold flavors, made with love"</div>
    </div>

    <!-- Order Form -->
    <form id="orderForm">
      <!-- Order Summary -->
      <div class="form-section">
        <h2 class="section-title">üìã Your Order</h2>
        <div id="orderSummary">
          <!-- Order items will be populated here -->
        </div>
      </div>

      <!-- Customer Details -->
      <div class="form-section">
        <h2 class="section-title">üë§ Your Details</h2>
        
        <div class="form-group">
          <label for="customerName" class="form-label">Full Name *</label>
          <input type="text" id="customerName" name="customerName" class="form-input" required aria-describedby="nameError" aria-label="Enter your full name">
          <div class="error-message hidden" id="nameError" role="alert" aria-live="polite"></div>
        </div>
        
        <div class="form-group">
          <label for="customerEmail" class="form-label">Email Address *</label>
          <input type="email" id="customerEmail" name="customerEmail" class="form-input" required aria-describedby="emailError" aria-label="Enter your email address">
          <div class="error-message hidden" id="emailError" role="alert" aria-live="polite"></div>
        </div>
        
        <div class="form-group">
          <label for="customerPhone" class="form-label">Phone Number *</label>
          <input type="tel" id="customerPhone" name="customerPhone" class="form-input" required aria-describedby="phoneError" aria-label="Enter your phone number">
          <div class="error-message hidden" id="phoneError" role="alert" aria-live="polite"></div>
        </div>
      </div>

      <!-- Delivery Details -->
      <div class="form-section">
        <h2 class="section-title">üè† Delivery Address</h2>
        
        <div class="form-group">
          <label for="deliveryAddress" class="form-label">Full Address *</label>
          <textarea id="deliveryAddress" name="deliveryAddress" class="form-input" rows="3" 
                    placeholder="House number, street name, area..." required aria-describedby="addressError" aria-label="Enter your full delivery address"></textarea>
          <div class="error-message hidden" id="addressError" role="alert" aria-live="polite"></div>
        </div>
        
        <div class="form-group">
          <label for="postcode" class="form-label">Postcode *</label>
          <input type="text" id="postcode" name="postcode" class="form-input" 
                 placeholder="e.g., NN5 7DG" style="text-transform:uppercase" required aria-describedby="postcodeError postcodeSuccess" aria-label="Enter your postcode">
          <div class="error-message hidden" id="postcodeError" role="alert" aria-live="polite"></div>
          <div class="success-message hidden" id="postcodeSuccess" role="status" aria-live="polite"></div>
        </div>
        
        <div id="deliveryInfo" class="delivery-info hidden">
          <!-- Delivery information will be shown here -->
        </div>
      </div>

      <!-- Order Total -->
      <div class="form-section order-total">
        <h2 class="section-title">üí∞ Order Total</h2>
        <div id="orderTotal">
          <!-- Total breakdown will be shown here -->
        </div>
        
        <button type="submit" class="btn" id="submitBtn" disabled aria-label="Complete your order and proceed to payment">
          <span id="submitText">Complete Order</span>
        </button>
        
        <p style="text-align:center;font-size:13px;color:var(--bronze);margin-top:16px;">
          You'll be redirected to WhatsApp to confirm your order and receive payment details.
        </p>
      </div>
    </form>
  </div>

  <script>
    // Get order data from URL or localStorage
    let orderData = JSON.parse(localStorage.getItem('boldMunchOrder') || '{"items":[],"subtotal":0}');
    
    let deliveryFee = 0;
    let deliveryValidated = false;
    
    // Remove item from order
    function removeOrderItem(index) {
      if (confirm('Remove this item from your order?')) {
        orderData.items.splice(index, 1);
        
        // Recalculate subtotal
        orderData.subtotal = orderData.items.reduce((sum, item) => {
          const price = item.price || item.product?.price || 0;
          const qty = item.qty || item.quantity || 1;
          return sum + (price * qty);
        }, 0);
        
        // Update localStorage
        localStorage.setItem('boldMunchOrder', JSON.stringify(orderData));
        
        // Refresh display
        populateOrderSummary();
        checkFormValidation();
        
        // If no items left, redirect to menu
        if (orderData.items.length === 0) {
          alert('Your cart is now empty. Redirecting to menu...');
          window.location.href = '/';
        }
      }
    }
    
    // Populate order summary
    function populateOrderSummary() {
      const summaryDiv = document.getElementById('orderSummary');
      
      if (!orderData.items || orderData.items.length === 0) {
        summaryDiv.innerHTML = '<p>No items in your order. <a href="/">Go back to menu</a></p>';
        return;
      }
      
      let html = '';
      orderData.items.forEach((item, index) => {
        // Handle both old and new cart item structures
        const name = item.name || item.product?.name || 'Unknown Item';
        const price = item.price || item.product?.price || 0;
        const qty = item.qty || item.quantity || 1;
        const size = item.size || '';
        const variety = item.variety || '';
        
        html += `
          <div class="order-item">
            <div class="item-details">
              <div class="item-name">${name}</div>
              <div class="item-meta">Quantity: ${qty}${size ? ` ‚Ä¢ Size: ${size}` : ''}${variety ? ` ‚Ä¢ ${variety}` : ''}</div>
            </div>
            <div style="display:flex;align-items:center;">
              <div class="item-price">¬£${(price * qty).toFixed(2)}</div>
              <button class="remove-item-btn" onclick="removeOrderItem(${index})" title="Remove item">√ó</button>
            </div>
          </div>
        `;
      });
      
      summaryDiv.innerHTML = html;
      updateOrderTotal();
    }
    
    // Update order total
    function updateOrderTotal() {
      const totalDiv = document.getElementById('orderTotal');
      const total = orderData.subtotal + deliveryFee;
      
      let html = `
        <div class="total-row">
          <span>Subtotal:</span>
          <span>¬£${orderData.subtotal.toFixed(2)}</span>
        </div>
        <div class="total-row">
          <span>Delivery Fee:</span>
          <span>¬£${deliveryFee.toFixed(2)}</span>
        </div>
        <div class="total-row final">
          <span>Total:</span>
          <span>¬£${total.toFixed(2)}</span>
        </div>
      `;
      
      totalDiv.innerHTML = html;
    }
    
    // Validate postcode and calculate delivery
    async function validatePostcode() {
      const postcodeInput = document.getElementById('postcode');
      const postcode = postcodeInput.value.trim().toUpperCase();
      const errorDiv = document.getElementById('postcodeError');
      const successDiv = document.getElementById('postcodeSuccess');
      const deliveryDiv = document.getElementById('deliveryInfo');
      
      if (!postcode) {
        return;
      }
      
      // Clear previous messages
      errorDiv.classList.add('hidden');
      successDiv.classList.add('hidden');
      deliveryDiv.classList.add('hidden');
      postcodeInput.classList.remove('error');
      
      // Show loading
      postcodeInput.classList.add('loading');
      
      try {
        console.log('Validating postcode:', postcode);
        
        const response = await fetch('/api/delivery/validate-postcode', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ postcode })
        });
        
        console.log('Postcode response status:', response.status);
        const data = await response.json();
        console.log('Postcode response data:', data);
        
        if (data.success) {
          deliveryFee = data.delivery.deliveryFee;
          deliveryValidated = true;
          
          // Show success
          successDiv.textContent = `‚úì Valid postcode: ${data.postcode}`;
          successDiv.classList.remove('hidden');
          
          // Show delivery info
          let deliveryClass = 'delivery-info';
          let deliveryText = '';
          
          if (data.delivery.inDeliveryArea) {
            if (data.delivery.deliveryFee === 0) {
              deliveryClass += ' delivery-free';
              deliveryText = `üéâ FREE DELIVERY! Your address is in our ${data.delivery.zoneName} (estimated ${data.delivery.maxDistanceMinutes} minutes)`;
            } else {
              deliveryClass += ' delivery-paid';
              deliveryText = `üöö Delivery available! ¬£${data.delivery.deliveryFee} delivery fee (${data.delivery.zoneName}, estimated ${data.delivery.maxDistanceMinutes} minutes)`;
            }
          } else {
            deliveryClass += ' delivery-unavailable';
            deliveryText = `
              <div style="margin-bottom: 16px;">
                ‚ùå Sorry, we don't deliver to this area yet.
              </div>
              <div style="text-align: center;">
                <button onclick="makeSpecialDeliveryEnquiry('${data.postcode}')" 
                        style="padding: 12px 20px; background: linear-gradient(145deg, var(--burgundy), #D35400); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px;">
                  Make Enquiry for Special Delivery
                </button>
              </div>
            `;
            deliveryFee = 0;
            deliveryValidated = false;
          }
          
          deliveryDiv.className = deliveryClass;
          deliveryDiv.innerHTML = deliveryText;
          deliveryDiv.classList.remove('hidden');
          
          updateOrderTotal();
          checkFormValidation();
          
        } else {
          errorDiv.textContent = data.error || 'Invalid postcode';
          errorDiv.classList.remove('hidden');
          postcodeInput.classList.add('error');
          deliveryValidated = false;
          deliveryFee = 0;
          updateOrderTotal();
          checkFormValidation();
        }
        
      } catch (error) {
        console.error('Postcode validation error:', error);
        
        // Provide specific error messages based on error type
        let errorMessage = 'Unable to validate postcode. Please try again.';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = 'Network error - please check your connection and try again.';
        } else if (error.message && error.message.includes('timeout')) {
          errorMessage = 'Request timeout - the service may be busy. Please try again.';
        } else if (response && response.status === 500) {
          errorMessage = 'Postcode validation service temporarily unavailable. Please try again later.';
        }
        
        // Show user-friendly error with fallback option
        errorDiv.innerHTML = `
          <div>${errorMessage}</div>
          <div style="margin-top: 8px; font-size: 0.9em;">
            <span style="color: #666;">Having trouble? </span>
            <button type="button" onclick="showSpecialDeliveryEnquiry()" 
                    style="color: var(--accent-color); background: none; border: none; text-decoration: underline; cursor: pointer;">
              Make a special delivery enquiry
            </button>
          </div>
        `;
        
        errorDiv.classList.remove('hidden');
        postcodeInput.classList.add('error');
        deliveryValidated = false;
      } finally {
        postcodeInput.classList.remove('loading');
      }
    }
    
    // Check if form is valid
    function checkFormValidation() {
      const form = document.getElementById('orderForm');
      const submitBtn = document.getElementById('submitBtn');
      const formData = new FormData(form);
      
      const required = ['customerName', 'customerEmail', 'customerPhone', 'deliveryAddress', 'postcode'];
      const isValid = required.every(field => formData.get(field)?.trim()) && 
                     deliveryValidated && 
                     orderData.items.length > 0;
      
      // Debug logging
      console.log('Form validation check:', {
        formFields: Object.fromEntries(formData.entries()),
        deliveryValidated,
        hasItems: orderData.items.length > 0,
        isValid
      });
      
      submitBtn.disabled = !isValid;
    }
    
    // Submit order
    async function submitOrder(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      
      // Show loading
      submitBtn.disabled = true;
      submitText.innerHTML = '<span class="spinner"></span>Creating Order...';
      
      try {
        const formData = new FormData(event.target);
        
        // Convert cart items to order format
        const orderItems = orderData.items.map(item => ({
          productId: item.productId || item.product?.id || 'unknown',
          name: item.name || item.product?.name || 'Unknown Item',
          quantity: item.qty || item.quantity || 1,
          price: item.price || item.product?.price || 0,
          size: item.size || null,
          variety: item.variety || null
        }));
        
        const orderPayload = {
          customerName: formData.get('customerName').trim(),
          customerEmail: formData.get('customerEmail').trim(),
          customerPhone: formData.get('customerPhone').trim(),
          deliveryAddress: formData.get('deliveryAddress').trim(),
          postcode: formData.get('postcode').trim().toUpperCase(),
          items: orderItems,
          subtotal: orderData.subtotal
        };
        
        console.log('Submitting order payload:', orderPayload);
        
        const response = await fetch('/api/orders/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(orderPayload)
        });
        
        console.log('Order response status:', response.status);
        const data = await response.json();
        console.log('Order response data:', data);
        
        if (data.success) {
          // Generate WhatsApp message
          const whatsappResponse = await fetch('/api/whatsapp/generate-message', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ orderNumber: data.order.orderNumber })
          });
          
          const whatsappData = await whatsappResponse.json();
          
          if (whatsappData.success) {
            // Clear cart
            localStorage.removeItem('boldMunchOrder');
            
            // Redirect to WhatsApp
            window.location.href = whatsappData.whatsappUrl;
          } else {
            throw new Error('Failed to generate WhatsApp message');
          }
          
        } else {
          throw new Error(data.error || 'Failed to create order');
        }
        
      } catch (error) {
        console.error('Order submission error:', error);
        
        // Show more specific error message
        let errorMessage = 'There was an error creating your order. Please try again.';
        if (error.message.includes('WhatsApp')) {
          errorMessage = 'Order created successfully, but there was an issue opening WhatsApp. Please contact us directly.';
        } else if (error.message.includes('postcode')) {
          errorMessage = 'There was an issue with your postcode. Please check and try again.';
        } else if (error.message.includes('delivery')) {
          errorMessage = 'There was an issue with delivery validation. Please check your address.';
        } else if (error.message && error.message !== 'Failed to create order') {
          errorMessage = `Error: ${error.message}`;
        }
        
        alert(errorMessage);
        
        submitBtn.disabled = false;
        submitText.textContent = 'Complete Order';
      }
    }
    
    // Function to show special delivery enquiry (fallback for validation errors)
    function showSpecialDeliveryEnquiry() {
      const postcode = document.getElementById('postcode').value.trim().toUpperCase() || 'Unknown';
      makeSpecialDeliveryEnquiry(postcode);
    }
    
    // Function to make special delivery enquiry
    async function makeSpecialDeliveryEnquiry(postcode) {
      const message = `Hello Bold Munch! üöö

I'd like to enquire about special delivery to my area:

üìç Postcode: ${postcode}
üíº Order details: ${orderData.items.map(item => `${item.qty || 1}x ${item.name}`).join(', ')}
üí∞ Order value: ¬£${orderData.subtotal.toFixed(2)}

Could you please let me know if delivery is possible and what the cost would be?

Thank you!`;

      try {
        const response = await fetch('/api/whatsapp/generate-enquiry', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            enquiryType: 'special_delivery',
            message: message,
            postcode: postcode
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.whatsappUrl) {
          window.open(data.whatsappUrl, '_blank');
        } else {
          alert('Unable to open WhatsApp. Please contact us directly at your convenience.');
        }
      } catch (error) {
        console.error('WhatsApp enquiry error:', error);
        alert('Connection error. Please try contacting us directly.');
      }
    }
    
    // Event listeners
    document.getElementById('postcode').addEventListener('input', 
      debounce(validatePostcode, 500)
    );
    
    document.getElementById('orderForm').addEventListener('input', checkFormValidation);
    document.getElementById('orderForm').addEventListener('submit', submitOrder);
    
    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      populateOrderSummary();
      checkFormValidation();
    });
  </script>
</body>
</html>